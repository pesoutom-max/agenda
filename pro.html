<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FacilPyme Pro - Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="app-container">
        <header class="pro-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="logo">FacilPyme <span style="font-weight: 400; opacity: 0.6;">Pro</span></div>
                <div style="opacity: 0.6;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </div>
            </div>
        </header>

        <main id="pro-app">
            <section id="view-agenda" class="fade-in">
                <h1>Agenda de hoy</h1>
                <p class="subtitle" id="current-date-label">Cargando...</p>

                <div class="agenda-list" id="appointments-container">
                    <p style="text-align: center; color: var(--text-muted); padding: 20px;">Cargando citas en tiempo
                        real...</p>
                </div>

                <div style="margin-top: 40px; padding: 20px; background: #f8f8fb; border-radius: 12px;">
                    <h3 style="margin-bottom: 12px; font-size: 1rem;">Configuración rápida</h3>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <a href="index.html?view=pro" class="btn-primary"
                            style="margin: 0; padding: 10px; font-size: 0.9rem; background: #28a745; text-decoration: none; display: flex; align-items: center; justify-content: center; flex: 1; min-width: 140px;">+
                            Agendar Paciente</a>
                        <button class="btn-primary"
                            style="margin: 0; padding: 10px; font-size: 0.9rem; flex: 1; min-width: 140px;"
                            onclick="location.href='admin.html'">Configurar Horarios</button>
                    </div>
                </div>
            </section>
        </main>

        <nav
            style="position: sticky; bottom: 0; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 15px;">
            <div style="text-align: center; color: var(--primary); cursor: pointer;" onclick="location.href='pro.html'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                <div style="font-size: 0.7rem; font-weight: 600;">Hoy</div>
            </div>
            <div style="text-align: center; color: var(--text-muted); cursor: pointer;"
                onclick="location.href='admin.html'">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path
                        d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z">
                    </path>
                </svg>
                <div style="font-size: 0.7rem; font-weight: 600;">Gestionar</div>
            </div>
        </nav>
    </div>

    <script src="firebase-config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy, initializeFirestore, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);

        // Forzar conexión por Long Polling
        const db = initializeFirestore(app, {
            experimentalForceLongPolling: true,
        });

        const container = document.getElementById('appointments-container');
        const dateLabel = document.getElementById('current-date-label');

        // Formato de fecha para hoy YYYY-MM-DD
        const today = new Date().toLocaleDateString('en-CA'); // Usa formato YYYY-MM-DD localmente
        console.log("Hoy es:", today);
        dateLabel.innerText = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });

        // Query en tiempo real - Simplificada (quitamos el orderBy para evitar pedir índices al inicio)
        const q = query(
            collection(db, "appointments"),
            where("date", "==", today)
        );

        console.log("Iniciando escucha de citas en tiempo real para la fecha:", today);

        onSnapshot(q, (snapshot) => {
            console.log("¡Cambio detectado en Firestore! Documentos encontrados:", snapshot.size);
            container.innerHTML = '';

            const appointments = [];
            snapshot.forEach(doc => appointments.push({ id: doc.id, ...doc.data() }));

            if (appointments.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No hay citas para hoy (' + today + ').</p>';
                return;
            }

            // Ordenamos manualmente en JS
            appointments.sort((a, b) => a.time.localeCompare(b.time));

            appointments.forEach((data) => {
                const card = document.createElement('div');
                card.className = 'pro-card';
                if (data.status === 'cancelled') {
                    card.style.borderLeftColor = 'var(--text-muted)';
                    card.style.opacity = '0.7';
                }

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span class="status-badge" style="${data.status === 'cancelled' ? 'background: #FEEBEB; color: #FF3B30;' : ''}">
                            ${data.status === 'confirmed' ? 'Confirmada' : 'Cancelada'}
                        </span>
                        <div style="display: flex; gap: 8px;">
                            ${data.status === 'confirmed' ? `<button onclick="cancelApp('${data.id}')" style="background: none; border: 1px solid #FF3B30; color: #FF3B30; padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; cursor: pointer;">Cancelar</button>` : ''}
                        </div>
                    </div>
                    <div class="time">${data.time}</div>
                    <div class="name">${data.patientName}</div>
                    <div class="service">${data.serviceName}</div>
                `;
                container.appendChild(card);
            });
        }, (error) => {
            console.error("Error en tiempo real (PRO VIEW):", error);
            container.innerHTML = '<p style="text-align: center; color: #FF3B30; padding: 20px;">Error al conectar con Firebase. Revisa la consola (F12).</p>';
        });

        window.cancelApp = async function (id) {
            if (confirm("¿Estás seguro de que deseas cancelar esta cita?")) {
                await deleteDoc(doc(db, "appointments", id));
            }
        };
    </script>
</body>

</html>